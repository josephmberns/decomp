//
// This file was generated by the Retargetable Decompiler
// Website: https://retdec.com
//

#include <stdint.h>
#include <stdlib.h>
#include <unistd.h>
#include <windows.h>

// ------------------------ Structures ------------------------

struct _IO_FILE {
    int32_t e0;
};

// ------------------- Function Prototypes --------------------

int64_t entry_point(void);
int64_t function_100003bc0(void);
int64_t function_100003be0(int64_t a1);
int64_t function_100003bfc(void);
int64_t function_100003e80(int64_t a1, int64_t a2, int64_t a3, int64_t a4);
int32_t function_100003e8c(void (*func)());
void function_100003e98(int32_t status);
int32_t function_100003ea4(int32_t fd, int32_t cmd, ...);
int32_t function_100003eb0(struct _IO_FILE * stream);
int32_t function_100003ebc(char * s, struct _IO_FILE * stream);
char * function_100003ec8(char * name);
int64_t * function_100003ed4(int32_t size);
int32_t function_100003ee0(char * file, int32_t oflag, ...);
void function_100003eec(char * s);
int32_t function_100003ef8(char * format, ...);
int32_t function_100003f04(char * s);
int32_t function_100003f10(int32_t seconds);
int32_t function_100003f1c(char * s);
int32_t function_100003f28(char * name);

// --------------------- Global Variables ---------------------

char * g1; // 0x100008000

// ------- Dynamically Linked Functions Without Header --------

int64_t ___memcpy_chk(int64_t a1, int64_t a2, int64_t a3, int64_t a4);
int32_t _atexit(void (*a1)());
int32_t _fcntl(int32_t a1, int32_t a2, ...);
int32_t _fflush(struct _IO_FILE * a1);
int32_t _fputs(char * a1, struct _IO_FILE * a2);
char * _getenv(char * a1);
int64_t * _malloc(int32_t a1);
void _perror(char * a1);
int32_t _printf(char * a1, ...);
int32_t _puts(char * a1);
int32_t _strlen(char * a1);
int32_t _unlink(char * a1);

// ------------------------ Functions -------------------------

// Address range: 0x100003bc0 - 0x100003be0
int64_t function_100003bc0(void) {
    // 0x100003bc0
    int64_t v1; // 0x100003bc0
    _perror((char *)v1);
    _exit(1);
    // UNREACHABLE
}

// Address range: 0x100003be0 - 0x100003bfc
int64_t function_100003be0(int64_t a1) {
    // 0x100003be0
    return _unlink(g1);
}

// Address range: 0x100003bfc - 0x100003da4
int64_t function_100003bfc(void) {
    char * v1 = _getenv("HOME"); // 0x100003c10
    if (v1 == NULL || *v1 != 47) {
        // 0x100003c44
        _fputs("Bad home directory.\n", (struct _IO_FILE *)*(int64_t *)*(int64_t *)0x100004008);
        _exit(1);
        // UNREACHABLE
    }
    int32_t v2 = _strlen(v1); // 0x100003c68
    int64_t * v3 = _malloc(v2 + 19); // 0x100003c78
    int64_t v4 = (int64_t)v3; // 0x100003c78
    *(int64_t *)&g1 = v4;
    if (v3 == NULL) {
        // 0x100003c98
        function_100003bc0();
        // UNREACHABLE
    }
    int64_t v5 = v2; // 0x100003c68
    ___memcpy_chk(v4, (int64_t)v1, v5, -1);
    ___memcpy_chk((int64_t)g1 + v5, (int64_t)"/rosetta-code-lock", 19, -1);
    int32_t v6 = _open(g1, 514); // 0x100003d04
    if (v6 < 0) {
        // 0x100003d20
        function_100003bc0();
        // UNREACHABLE
    }
    // 0x100003d30
    if (_fcntl(v6, 8) >= 0) {
        // 0x100003d8c
        return _atexit((void (*)())0x100003be0);
    }
    int64_t v7 = *(int64_t *)*(int64_t *)0x100004008; // 0x100003d74
    _fputs("Another instance of this program is running.\n", (struct _IO_FILE *)v7);
    _exit(1);
    // UNREACHABLE
}

// Address range: 0x100003da4 - 0x100003e80
int64_t entry_point(void) {
    // 0x100003da4
    function_100003bfc();
    for (int32_t i = 10; i > 0; i--) {
        // 0x100003dd8
        int64_t v1; // 0x100003da4
        _printf("%d...%s", v1, (char *)v1);
        _fflush((struct _IO_FILE *)*(int64_t *)*(int64_t *)0x100004010);
        _sleep(1);
    }
    // 0x100003e64
    _puts("Fin!");
    return 0;
}

// Address range: 0x100003e80 - 0x100003e8c
int64_t function_100003e80(int64_t a1, int64_t a2, int64_t a3, int64_t a4) {
    // 0x100003e80
    return ___memcpy_chk(a1, a2, a3, a4);
}

// Address range: 0x100003e8c - 0x100003e98
int32_t function_100003e8c(void (*func)()) {
    // 0x100003e8c
    return _atexit(func);
}

// Address range: 0x100003e98 - 0x100003ea4
void function_100003e98(int32_t status) {
    // 0x100003e98
    _exit(status);
}

// Address range: 0x100003ea4 - 0x100003eb0
int32_t function_100003ea4(int32_t fd, int32_t cmd, ...) {
    // 0x100003ea4
    return _fcntl(fd, cmd);
}

// Address range: 0x100003eb0 - 0x100003ebc
int32_t function_100003eb0(struct _IO_FILE * stream) {
    // 0x100003eb0
    return _fflush(stream);
}

// Address range: 0x100003ebc - 0x100003ec8
int32_t function_100003ebc(char * s, struct _IO_FILE * stream) {
    // 0x100003ebc
    return _fputs(s, stream);
}

// Address range: 0x100003ec8 - 0x100003ed4
char * function_100003ec8(char * name) {
    // 0x100003ec8
    return _getenv(name);
}

// Address range: 0x100003ed4 - 0x100003ee0
int64_t * function_100003ed4(int32_t size) {
    // 0x100003ed4
    return _malloc(size);
}

// Address range: 0x100003ee0 - 0x100003eec
int32_t function_100003ee0(char * file, int32_t oflag, ...) {
    // 0x100003ee0
    return _open(file, oflag);
}

// Address range: 0x100003eec - 0x100003ef8
void function_100003eec(char * s) {
    // 0x100003eec
    _perror(s);
}

// Address range: 0x100003ef8 - 0x100003f04
int32_t function_100003ef8(char * format, ...) {
    // 0x100003ef8
    return _printf(format);
}

// Address range: 0x100003f04 - 0x100003f10
int32_t function_100003f04(char * s) {
    // 0x100003f04
    return _puts(s);
}

// Address range: 0x100003f10 - 0x100003f1c
int32_t function_100003f10(int32_t seconds) {
    // 0x100003f10
    return _sleep(seconds);
}

// Address range: 0x100003f1c - 0x100003f28
int32_t function_100003f1c(char * s) {
    // 0x100003f1c
    return _strlen(s);
}

// Address range: 0x100003f28 - 0x100003f34
int32_t function_100003f28(char * name) {
    // 0x100003f28
    return _unlink(name);
}

// --------------------- Meta-Information ---------------------

// Detected functions: 19

